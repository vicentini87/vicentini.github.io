<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PEDIDO</title>

<style>
  body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
  .container { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  h2 { margin:0 0 18px 0; }
  label { font-weight:700; display:block; margin-bottom:6px; }
  input, textarea, select { width:100%; padding:10px; margin:0 0 12px 0; border-radius:6px; border:1px solid #d0d0d0; box-sizing:border-box; text-transform:uppercase; }
  .row { display:flex; gap:12px; flex-wrap:wrap; }
  .row .field { flex:1; }
  button { padding:10px 16px; background:#0d6efd; border:none; border-radius:6px; color:#fff; cursor:pointer; }
  button.secondary { background:#6c757d; }
  table { width:100%; border-collapse:collapse; margin-top:16px; }
  th, td { padding:10px; border:1px solid #e6e6e6; }
  thead th { background:#f1f3f5; font-weight:700; }
  .remove-btn { cursor:pointer; color:#dc3545; font-weight:bold; font-size:15px; text-align:center; }

  /* -------- MOBILE -------- */
  @media(max-width:500px){

    .row { flex-direction: column; }
    .row .field { width:100% !important; max-width:100% !important; }

    input, textarea, select { font-size:16px; padding:14px; }

    button { width:100%; margin-top:10px; }

    th, td { font-size:14px; padding:8px; }

    h2, h3 { text-align:center; }

    #tabelaItens thead { display:none; }

    #tabelaItens tbody {
      display:flex;
      flex-direction:column;
      align-items:center;
      width:100%;
      gap: 12px;
      padding: 0;
      margin: 0;
    }

    #tabelaItens tbody tr {
      display:block;
      width:88%;
      max-width:420px;
      background:#fff;
      padding:14px 16px;
      border-radius:12px;
      border:1px solid #dfdfdf;
      position:relative;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      box-sizing:border-box;
      list-style: none;
    }

    #tabelaItens tbody tr td {
      display:block;
      width:100%;
      padding:2px 0 !important;
      border:none !important;
      color:#333;
      white-space:normal;
    }

    #tabelaItens tbody tr td:nth-child(2) {
      font-weight:700;
      margin-top:4px;
      margin-bottom:2px;
    }

    #tabelaItens tbody tr td:nth-child(3),
    #tabelaItens tbody tr td:nth-child(4),
    #tabelaItens tbody tr td:nth-child(5),
    #tabelaItens tbody tr td:nth-child(6) {
      display:inline-block;
      margin-right: 12px;
      font-size:13.5px;
      color:#555;
    }
  }
</style>
</head>

<body>
<div class="container">
  <h2 style="text-align:center; font-weight:800;">PEDIDO</h2>

  <!-- Dados principais -->
  <div style="max-width:760px; margin:12px auto 18px auto;">
    <div style="background:#fafafa; border:1px solid #ececec; border-radius:8px; padding:14px;">
        
      <!-- campo TIPO inserido antes de CLIENTE -->
      <div class="row">
        <div class="field" style="max-width:220px;">
          <label for="tipo">Tipo</label>
          <select id="tipo">
            <option value="PEDIDO PRODUÇÃO">PEDIDO PRODUÇÃO</option>
            <option value="PILOTAGEM">PILOTAGEM</option>
            <option value="AMOSTRA GRÁTIS">AMOSTRA GRÁTIS</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="cliente">Cliente</label>
          <input id="cliente" />
        </div>
        <div class="field">
          <label for="Fornecedor">Fornecedor</label>
          <input id="Fornecedor" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="pagamento">Pagamento</label>
          <input id="pagamento" />
        </div>
        <div class="field">
          <label for="transportadora">Transportadora</label>
          <input id="transportadora" />
        </div>
      </div>

      <div>
        <label for="observacoes">Observações</label>
        <textarea id="observacoes" rows="3"></textarea>
      </div>

    </div>
  </div>

  <h3>Itens do Pedido</h3>

  <div class="row" style="margin-bottom:10px;">
    <div class="field"><label for="produto">Produto</label><input id="produto" /></div>

    <div class="field" style="max-width:160px;">
      <label for="cor">Cor</label>
      <input id="cor" />
    </div>

    <div class="field" style="max-width:140px;">
      <label for="quantidade">Quantidade</label>
      <input id="quantidade" type="number" min="1" />
    </div>

    <div class="field" style="max-width:120px;">
      <label for="unidade">Unidade</label>
      <select id="unidade">
        <option value="MT">MT</option>
        <option value="KG">KG</option>
      </select>
    </div>

    <div class="field" style="max-width:140px;">
      <label for="valor">Valor Unitário</label>
      <input id="valor" inputmode="decimal" />
    </div>
  </div>

  <div style="display:flex; gap:10px; margin-bottom:8px;">
    <button id="btnAdd" type="button">Adicionar Item</button>
    <button id="btnClear" type="button" class="secondary">Limpar campos</button>
  </div>

  <table id="tabelaItens" aria-label="Itens do pedido">
    <thead>
      <tr>
        <th>✖</th>
        <th>Produto</th>
        <th>Cor</th>
        <th>Qtd</th>
        <th>Unid.</th>
        <th>Valor Unit.</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:10px;">
    <button id="btnPdf" type="button">Salvar Pedido em PDF</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let numeroPedidoAtual = Number(localStorage.getItem('numeroPedido'));
if (!numeroPedidoAtual || numeroPedidoAtual < 1000) { numeroPedidoAtual = 1000; }

function escapeHtml(text) {
  return String(text || '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}

function toNumber(v) {
  if (!v) return 0;
  return Number(String(v).replace(/\./g, "").replace(",", "."));
}

function formatarMoeda(valor) {
  return Number(valor).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
}

document.getElementById("valor").addEventListener("input", function(){
    this.value = this.value
      .replace(/[^0-9,.]/g, "")
      .replace(/,+/g, ",")
      .replace(/\.{2,}/g, ".");
});

function adicionarItem() {
  const produto = document.getElementById('produto').value.trim().toUpperCase();
  const cor = document.getElementById('cor').value.trim().toUpperCase();
  const qtd = Number(document.getElementById('quantidade').value);
  const unidade = document.getElementById('unidade').value;
  const valor = toNumber(document.getElementById('valor').value.trim());

  if (!produto || !cor || !qtd || !unidade || !valor) {
    alert('Preencha Produto, Cor, Quantidade, Unidade e Valor corretamente.');
    return;
  }

  const tbody = document.querySelector('#tabelaItens tbody');
  const tr = document.createElement('tr');

  tr.innerHTML = `
    <td class="remove-btn">✖</td>
    <td>${escapeHtml(produto)}</td>
    <td>${escapeHtml(cor)}</td>
    <td>${qtd}</td>
    <td>${unidade}</td>
    <td>${formatarMoeda(valor)}</td>
  `;

  tr.querySelector('.remove-btn').addEventListener('click', ()=> tr.remove());
  tbody.appendChild(tr);

  document.getElementById('produto').value = '';
  document.getElementById('cor').value = '';
  document.getElementById('quantidade').value = '';
  document.getElementById('unidade').value = 'MT';
  document.getElementById('valor').value = '';
}

function gerarPDF(){
  numeroPedidoAtual++;
  localStorage.setItem('numeroPedido', numeroPedidoAtual);
  const pedidoNum = `PED-${numeroPedidoAtual}`;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });

  const tipo = document.getElementById('tipo').value.toUpperCase();
  const cliente = document.getElementById('cliente').value.toUpperCase();
  const Fornecedor = document.getElementById('Fornecedor').value.toUpperCase();
  const pagamento = document.getElementById('pagamento').value.toUpperCase();
  const transp = document.getElementById('transportadora').value.toUpperCase();
  const obs = document.getElementById('observacoes').value.toUpperCase();

  const linhas = document.querySelectorAll('#tabelaItens tbody tr');
  const pageW = doc.internal.pageSize.getWidth();
  const now = new Date();
  const dataHora = now.toLocaleString('pt-BR',{ hour12:false });

  function cab(y){
    doc.setFontSize(18).setFont(undefined,'bold');
    doc.text('PEDIDO', pageW/2, y, { align:'center' });
    doc.setFontSize(10).setFont(undefined,'normal');
    doc.text(`Nº: ${pedidoNum}`, 40, y);
    doc.text(`Data/Hora: ${dataHora}`, pageW-150, y);
  }
  cab(40);

  let y = 70;
  const margem = 40;
  const largura = pageW - margem*2;

  // retângulo que envolve Tipo..Observações
  const boxHeight = 140;
  doc.roundedRect(margem, y, largura, boxHeight, 6, 6);
  const lx = margem+15, vx = margem+140;

  // posicionamento interno do box (valores calculados para caber dentro)
  const line1 = y + 22; // Tipo
  const line2 = y + 42; // Cliente
  const line3 = y + 62; // Fornecedor
  const line4 = y + 82; // Pagamento
  const line5 = y + 102; // Transportadora
  const obsY   = y + 122; // Observações (vai quebrar se longo)

  doc.setFont(undefined,'bold');
  doc.text("Tipo:", lx, line1);
  doc.text("Cliente:", lx, line2);
  doc.text("Fornecedor:", lx, line3);
  doc.text("Pagamento:", lx, line4);
  doc.text("Transportadora:", lx, line5);
  doc.text("Observações:", lx, obsY);

  doc.setFont(undefined,'normal');
  doc.text(tipo, vx, line1);
  doc.text(cliente, vx, line2);
  doc.text(Fornecedor, vx, line3);
  doc.text(pagamento, vx, line4);
  doc.text(transp, vx, line5);
  doc.text(doc.splitTextToSize(obs, largura - 160), vx, obsY);

  y += boxHeight + 20;

  const colProdutoX = margem+30;
  const colCorX = margem+260;
  const colQtdX = margem+340;
  const colUnidX = margem+390;
  const colValorX = margem+450;

  const headerHeight = 24, rowHeight = 28;

  function tabelaCab(){
    doc.setFont(undefined,'bold');
    doc.rect(margem, y, largura, headerHeight);
    doc.text("Produto", colProdutoX, y+16);
    doc.text("Cor", colCorX, y+16);
    doc.text("Qtd", colQtdX, y+16);
    doc.text("Unid.", colUnidX, y+16);
    doc.text("Valor un.", colValorX, y+16);
    y += headerHeight+2;
    doc.setFont(undefined,'normal');
  }
  tabelaCab();

  linhas.forEach(row=>{
    const cols = row.querySelectorAll('td');
    const produto = cols[1].textContent.trim().toUpperCase();
    const cor = cols[2].textContent.trim().toUpperCase();
    const qtd = cols[3].textContent.trim();
    const unidade = cols[4].textContent.trim().toUpperCase();
    const valor = cols[5].textContent.trim();

    if(y > doc.internal.pageSize.getHeight() - 100){
      doc.addPage();
      y = 60;
      cab(40);
      // redraw box on new page (if needed)
      doc.roundedRect(margem, 70, largura, boxHeight, 6, 6);
      tabelaCab();
    }

    doc.rect(margem, y, largura, rowHeight);
    doc.text(produto, colProdutoX, y+18);
    doc.text(cor, colCorX, y+18);
    doc.text(qtd, colQtdX, y+18);
    doc.text(unidade, colUnidX, y+18);
    doc.text(valor, colValorX, y+18);
    y += rowHeight;
  });

  // ================================
  //    INSERE IMAGEM NO RODAPÉ
  // ================================
  const imgUrl = "https://iili.io/fAeHimP.png";
  const img = new Image();
  img.crossOrigin = "Anonymous";

  img.onload = function () {
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    const imgWidth = 240;
    const imgHeight = 70;

    const posX = (pageWidth - imgWidth) / 2;
    const posY = pageHeight - imgHeight - 20;

    doc.addImage(img, "PNG", posX, posY, imgWidth, imgHeight);
    doc.save(`${pedidoNum}.pdf`);
  };

  img.src = imgUrl;
  return;
}

document.getElementById('btnAdd').addEventListener('click', adicionarItem);
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('produto').value='';
  document.getElementById('cor').value='';
  document.getElementById('quantidade').value='';
  document.getElementById('unidade').value='MT';
  document.getElementById('valor').value='';
});
document.getElementById('btnPdf').addEventListener('click', gerarPDF);
</script>

</body>
</html>
